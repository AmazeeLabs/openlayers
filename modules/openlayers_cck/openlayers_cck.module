<?php
// $Id$

/**
 * @file
 * This file holds the main Drupal hook functions 
 * and private functions for the openlayers_cck module.
 *
 * @ingroup openlayers
 */

/**
 * Map ID Prefix
 */
define('OPENLAYERS_CCK_MAP_ID_PREFIX', 'openlayers-cck-map-auto-id');

/**
 * Implementation of hook_help
 */
function openlayers_cck_help($path, $arg) {
  switch ($path) {
    case 'admin/help#openlayers_cck':
      $output = '<p>'. t('The openlayers_cck module provides fields and widgets that interface with OpenLayers.') .'</p>';
  }
  
  return $output;
}

/**
 * Implementation of hook_theme().
 */
function openlayers_cck_theme() {
  return array(
    'openlayers_cck_geo_field' => array(
      'arguments' => array(
        'element' => NULL
      ),
    ),
    'openlayers_cck_map' => array(
      'arguments' => array(
        'field' => NULL,
        'mapid' => NULL,
      ),
    ),
    'openlayers_cck_formatter_openlayersmapformatter_grouped' => array(
      'arguments' => array('element' => NULL),
    ),
    'openlayers_cck_formatter_openlayersmapformatter_single' => array(
      'arguments' => array('element' => NULL),
    ),

  );
}

/**
 * Implementation of hook_widget_info
 */
function openlayers_cck_widget_info() {
  $info = array();
  
  // Check for geo_field module
  if (module_exists('geo_field')) {
    $info['openlayers_cck_geo_field'] = array(
      'label' => t('OpenLayers Map Widget'),
      'field types' => array('geo'),
    );
  }
  
  return $info;
}

/**
 * Implementation of hook_widget_settings().
 */
function openlayers_cck_widget_settings($op, $widget) {
  switch ($op) {
    case 'form':
      // Get defaults, check if there are already defaults
      // @@TODO: What if the global defaults have not been created in the interface
      if (isset($widget['openlayers_cck'])) {
        $defaults = $widget['openlayers_cck'];
      }
      else {
        $defaults = variable_get('openlayers_defaults_form', array());
      }
      
      // Get map form
      $map_form = openlayers_map_form($defaults);
      
      // Put form into a collapsed fieldset, as this promotes good usability
      // Most users will not want to edit these fields
      $form['openlayers_cck'] = $map_form;
      $form['openlayers_cck']['#type'] = 'fieldset';
      $form['openlayers_cck']['#title'] = 'Map Settings';
      $form['openlayers_cck']['#description'] = 'These are the settings that determine how the map will look.';
      $form['openlayers_cck']['#collapsible'] = 'TRUE';
      $form['openlayers_cck']['#collapsed'] = 'TRUE';
      // Return form
      return $form;

    case 'validate':
      openlayers_map_form_validate($widget['openlayers_cck']);
      break;

    case 'save':
      // @@TODO: Figure out a way to save this form in an easy way.
      // Ideally we just want to save the map array.
      // We could create a DB table to save this information.
      return array('openlayers_cck');
  }
}

/**
 * Implementation of hook_widget().
 */
function openlayers_cck_widget(&$form, &$form_state, $field, $items, $delta = 0) {
  // @@TODO: Put this outside the widget, but inside the field, so it is not rendered
  // for each item in the field.  Not sure how this is done.
  
  $fieldname = $field['field_name'];
  // Only include map once per field
  static $included_field = '';
  if ($included_field != $fieldname) {
    // Create map
    $mapid = OPENLAYERS_CCK_MAP_ID_PREFIX .'-'. $fieldname;
    $map['id'] = $mapid;
    
    // Add an event to the map. When a layer is added fire the JavaScript function openlayersCCKLoadValues.
    // openlayersCCKLoadValues takes care of loading data from the CCK fields into the map.
    $map['events'] = array(
      'beforeBehaviors' => array('openlayersCCKLoadValues'),
    );
    
    $map['behaviors'] = array(
      'openlayers_cck_zoom_to_layer' => array(
        'id' => 'openlayers_cck_zoom_to_layer',
        'type' => 'openlayers_behaviors_zoom_to_layer',
        'layer' => 'openlayers_cck_vector',
      ),
    );
    
    // Make sure that our display projection matches the database projection
    if ($field['db_storage'] == 0){
      $field['db_storage'] = '4326';
    }
    $map['options'] = array(
      'displayProjection' => $field['db_storage'],
    );
    
    // Define a vector layer for our features
    $map['layers'] = array(
      'openlayers_cck_vector' => array(
        'id' => 'openlayers_cck_vector',
        'type' => 'Vector',
        'name' => $field['widget']['label'],
        'options' => array(),
        'events' => array(
          'featureselected' => array('openlayersCCKFeaturesSelected'),
          'featureunselected' => array('openlayersCCKFeaturesUnselected'),
        ),
      ),
    );
    
    // Look at field type, and add respective control
    switch ($field['geo_type']) {
      case 'point':
        $map['draw_features'] = array(
          'point' => array(
            'type' => 'Point',
            'vector' => 'openlayers_cck_vector',
            'featureadded_handler' => array('openlayersCCKFeatureAdded'),
            'featuremodified_handler' => array('openlayersCCKFeatureModified'),
            'featureremoved_handler' => array('openlayersCCKFeatureRemoved'),
          ),
        );
        break;
        
      case 'linestring':
        $map['draw_features'] = array(
          'path' => array(
            'type' => 'Path',
            'vector' => 'openlayers_cck_vector',
            'featureadded_handler' => array('openlayersCCKFeatureAdded'),
            'featuremodified_handler' => array('openlayersCCKFeatureModified'),
            'featureremoved_handler' => array('openlayersCCKFeatureRemoved'),
          ),
        );
        break;
        
      case 'polygon':
        $map['draw_features'] = array(
          'polygon' => array(
            'type' => 'Polygon',
            'vector' => 'openlayers_cck_vector',
            'featureadded_handler' => array('openlayersCCKFeatureAdded'),
            'featuremodified_handler' => array('openlayersCCKFeatureModified'),
            'featureremoved_handler' => array('openlayersCCKFeatureRemoved'),
          ),
        );
        break;
    
    }
    
    // Use widget settings form to create base map array
    $widget_map = openlayers_convert_form_to_map($field['widget']['openlayers_cck']);
    
    $map = openlayers_merge_maps($widget_map, $map);
    
    // Add JS
    drupal_add_js(drupal_get_path('module', 'openlayers_cck') .'/js/openlayers_cck.js');
    //Add CSS
    drupal_add_css(drupal_get_path('module', 'openlayers_cck') .'/openlayers_cck.css', 'module');
    
    // Render Map
    $rendered_map = openlayers_render_map($map);
    
    // Put together array for JS
    $openlayers_cck = array(
      'openlayers_cck' => array(
        'maps' => array(
          $mapid => array(
            'field_name' => $fieldname,
            'field_data' => $field,
            'field_name_js' => str_replace('_', '-', $fieldname), // Best way?
            'field_map_themed' => theme('openlayers_cck_map', $field, $rendered_map),
            'field_container' => str_replace('_', '-', $fieldname) .'-items',  // Best way??
            'field_items' => $items,
          ),
        ),
      ),
    );

    // Add JS settings
    drupal_add_js($openlayers_cck, 'setting');
    // Change static variable
    $included_field = $fieldname;
  }

  // Return widget array
  return array(
    '#type' => $field['widget']['type'],
    '#default_value' => isset($items[$delta]) ? $items[$delta] : '',
  );
}

/**
 * Implementation of FAPI hook_elements().
 */
function openlayers_cck_elements() {
  return array(
    'openlayers_cck_geo_field' => array(
      '#input' => TRUE,
      '#columns' => array('lat', 'lon', 'wkt'),
      '#delta' => 0,
      '#process' => array('openlayers_cck_geo_field_process'),
    ),
  );
}

/**
 * Process an individual element.
 *
 * Build the form element. When creating a form using FAPI #process,
 * note that $element['#value'] is already set.
 *
 * The $fields array is in $form['#field_info'][$element['#field_name']].
 */
function openlayers_cck_geo_field_process($element, $edit, $form_state, $form) {
  // Define some variables
  $field = $form['#field_info'][$element['#field_name']];
  $delta = $element['#delta'];
  $field_data = content_fields($element['#field_name'], $element['#type_name']);
    
  // Define elements
  $element['wkt'] = array(
    '#type' => 'textarea',
    '#title' => t($field['widget']['label']),
    '#rows' => 2,
    '#default_value' => isset($element['#value']['wkt']) ? $element['#value']['wkt'] : NULL,
    '#required' => $field['required'],
    '#description' => $field['widget']['description'],
    '#attributes' => array('rel' => OPENLAYERS_CCK_MAP_ID_PREFIX .'-'. $field['field_name']),
  );
  
  // Remove title and description for multiple
  if ($field_data['multiple'] > 0) {
    unset($element['wkt']['#title']);
    unset($element['wkt']['#description']);
  }
  
  return $element;
}

/**
 * Theme function for openlayers_cck_geo_field element
 */
function theme_openlayers_cck_geo_field($element) {
  return $element['#children'];
}

/**
 * Theme function for openlayers_cck_map
 */
function theme_openlayers_cck_map($field = array(), $map = array()) {
  $output = '
    <div class="form-item openlayers-cck-widget-container">
      <label for="'. $map['id'] .'">'. $field['widget']['label'] .'</label>
      '. $map['themed'] .'
      <div class="description openlayers-cck-field-description">
        '. $field['widget']['description'] .'
      </div>
      <div class="description openlayers-cck-map-instructions">'.t('Click the tools in the upper right-hand corner of the map to switch between draw mode and zoom/pan mode. Draw your shape, double-clicking to finish. You may edit your shape using the control points. To delete a shape, select it and press the delete key. To delete a vertex hover over it and press the d key.').'</div>
      <div class="openlayers-cck-actions">
        <a href="#" id="'. $map['id'] .'-wkt-switcher" rel="'. $map['id'] .'">'. t('Show/Hide WKT Fields') .'</a>
      </div>
    </div>
  ';
  return $output;
}


/**
 * Implementation of hook_field_formatter_info(),.
 */
function openlayers_cck_field_formatter_info() {
  return array(
    // @@TOOD: Implement Grouped Formatter.
    //'openlayersmapformatter_grouped' => array(
    //  'label' => t('OpenLayers Grouped Map'),
    //  'field types' => array('geo'),
    //  'multiple values' => CONTENT_HANDLE_MODULE,
    //),
    'openlayersmapformatter_single' => array(
      'label' => t('OpenLayers Single Map'),
      'field types' => array('geo'),
      'multiple values' => CONTENT_HANDLE_MODULE,
    ),
  );
}

/**
 * Theme a group of fields using just one map. Each field is given one layer.
 * 
 */
function theme_openlayers_cck_formatter_openlayersmapformatter_grouped($element) {
  // @@TODO: We may want to use nodeapi to do this instead of using a field formatter
  // Since we are grouping all fields, we only ever want to process this function once.
  
  static $processed = FALSE;
  if (!$processed){
    $node = $element['#node'];
    
    $mapid = "openlayers-cck-field-". $node->nid ."-grouped";
    
    // @@TODO: Put in a map form somewhere to configure the rest of the map properties.
    // @@TODO: Should we be using the hook_nodeapi for this?  Given that it is currently displaying under the header of the first field?

    // Go through the layers. Each field get it's own layer.
    $layers = array();
    foreach ($node->geo_fields as $geofield_key){
      // Check to make sure this field is using the grouped formatter
      $formatter = $node->content[$geofield_key]['field']['items']['#formatter'];
      if ($formatter == 'openlayersmapformatter_grouped'){
        
        // Add basic information to the layer in the map array
        $field_info = $node->content[$geofield_key]['field'];
        $layers[$geofield_key] = array(
          'id' => $geofield_key,
          'type' => 'Vector',
          'name' => $field_info['#title'],
        );
        
        // Add features to the map
        $layers[$geofield_key]['features'] = array();
        foreach ($node->$geofield_key as $feature){
          $layers[$geofield_key]['features'][] = array(
            'wkt' => $feature['wkt'],
            'projection' => $feature[$geofield_key."_srid"],
            'attributes' => array(
              'name' => $node->node_title, 
              'nid' => $node->nid, 
            ),
          );
        }
      }
    }
    
    // Build our map array
    $map_def = array(
      'id' => $mapid,
      'layers' => $layers,
    );

    
    $map = openlayers_render_map($map_def);
        
    $processed = TRUE;
    return $map['themed'];
  }
  else{
    return false;
  }
}

/**
 * Theme a fields using a map. Each field is given a map.
 */
function theme_openlayers_cck_formatter_openlayersmapformatter_single($element) { 
  // @@TODO: Put in a map form somewhere to configure the rest of the map properties.
  // @@BUG:  When in a view, infinite recursion if more than one value exists per field per node and "each value in it's own row" is set to false in view field settings.
  // @@BUG:  When in a view, and the multivalue option is set to "each value in it's own row" then the element is formed as a single, and SRID (projection) is nowhere to be found in $element. This is most likely a bug in geo - but i'm not sure.
  
  // Define some common variables
  $node = $element['#node'];
  $geofield_key = $element['#field_name'];
  $srid_key = $geofield_key."_srid";
  $mapid = "openlayers-cck-field-". $node->nid ."-single-". $geofield_key;
  
  // Name our features. If we are in a view, name the feature by the node name.
  // If we are in a page, name the feature by the field name. This is necessary
  // because the tricky $element changes it's form depending on context.
  if ($element['#title']){
    $feature_name = $element['#title'];
  }
  elseif ($node->content[$geofield_key]['field']['#title']){
    $feature_name = $node->content[$geofield_key]['field']['#title'];
  }
  else {
    $feature_name = $node->node_title;
  }
  
  // Prepare our layers array.
  $layers = array();
  // Add basic information to the layer in the map array
  $layers[$geofield_key] = array(
    'id' => $geofield_key,
    'type' => 'Vector',
    'name' => $feature_name, 
  );
  $layers[$geofield_key]['features'] = array();
  
  // Add features to the map definition
  foreach ($element  as $key => $feature){
    if (is_numeric($key)){
      $layers[$geofield_key]['features'][] = array(
        'wkt' => $feature['#item']['wkt'],
        'projection' => $feature['#item'][$srid_key],
        'attributes' => array(
          'name' => $feature_name, 
          'nid' => $node->nid, 
        ),
      );
    }
  }
  
  // If there are any features to display, then display the map
  if (count($layers[$geofield_key]['features'])){
    // Build our map array
    $map_def = array(
      'id' => $mapid,
      'layers' => $layers,
      'behaviors' => array(
        'openlayers_cck_zoom_to_layer' => array(
          'id' => 'openlayers_cck_zoom_to_layer',
          'type' => 'openlayers_behaviors_zoom_to_layer',
          'layer' => $geofield_key,
        ),
      )
    );
    
    $map = openlayers_render_map($map_def);
    
    return $map['themed'];
  }
}