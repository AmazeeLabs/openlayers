<?php
// $Id$

/**
 * @file
 * OpenLayers
 */

/**
 * Implementation of hook_menu().
 */
function openlayers_menu($may_cache) {
  if ($may_cache) {
    $items[] = array(
      'path' => 'openlayerstest',
      'callback' => 'openlayers_test',
      'access' => TRUE,
      'type' => MENU_CALLBACK,
    );
    return $items;
  }
  else {
    drupal_add_css(drupal_get_path('module', 'openlayers') .'/openlayers.css');
  }
}

/**
 * Page callback: Hello World
 */
function openlayers_test() {
  drupal_set_html_head('<script type="text/javascript" src="http://openlayers.org/api/2.5-rc3/OpenLayers.js"></script>');

  $output = <<<EOD
    <div id='openlayerstestmap'></div>
    <script type="text/javascript">
$(document).ready(function() {
      var map = new OpenLayers.Map('openlayerstestmap',{maxResolution: 0.703125} );
      var wmscURL = [
        "http://wmsc1.terrapages.net/getmap?",
        "http://wmsc2.terrapages.net/getmap?",
        "http://wmsc3.terrapages.net/getmap?",
        "http://wmsc4.terrapages.net/getmap?"
      ];
      var terrapagesStreetLayer = new OpenLayers.Layer.WMS( 'TerraPages Street',wmscURL, {layers: 'UnprojectedStreet', format: 'image/jpeg' }, {buffer: 1, isBaseLayer: true} );

      var vectorLayer = new OpenLayers.Layer.Vector("Vector Layer", {displayInLayerSwitcher: false});

      map.addLayers([terrapagesStreetLayer, vectorLayer]);

      map.addControl(new OpenLayers.Control.Navigation());
      map.addControl(new OpenLayers.Control.PanZoomBar());
      map.addControl(new OpenLayers.Control.MousePosition());
      map.addControl(new OpenLayers.Control.Permalink());
      map.addControl(new OpenLayers.Control.LayerSwitcher());
      map.addControl(new OpenLayers.Control.EditingToolbar(vectorLayer));

      var theWKT = new OpenLayers.Format.WKT();

      var loading = false;

      vectorLayer.onFeatureInsert = function(feature) {
        if (!loading) {
          $('#edit-testwkt').val(theWKT.write(feature.layer.features));
        }
      }

      map.zoomToMaxExtent();

      
      $('#thetestlink').click(function() {
        loading = true;
        vectorLayer.destroyFeatures();
        vectorLayer.addFeatures(theWKT.read($('#edit-testwkt').val()));
        loading = false;
      });


});

    </script>
EOD;

  $output .= drupal_get_form('openlayers_test_form');
  return $output;
}

function openlayers_test_form() {
  $form = array();
  $form['testwkt'] = array(
    '#type' => 'textarea',
    '#rows' => 6,
  );
  $form['loadit'] = array(
    '#value' => '<a href="#" id="thetestlink">Load WKT from textarea</a>',
  );

  return $form;
}